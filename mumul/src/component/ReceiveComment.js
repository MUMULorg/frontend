import React, { useState, useEffect } from "react";
import moment from "moment";
import "moment/locale/ko";
import Heart from "./../img/icHeaderBlack.png";
import LineHeart from "./../img/icHeartWhite.png";
import More from "./../img/icon/icMore.png";
import Share from "./../img/icon/icShare.png";
import Good from "./../img/icon/icGood.png";
import GoodRed from "./../img/icon/icGoodRed.png";
import InstaLogo from "./../img/icon/instaLogo.jpeg";
import CopyLink from "./../img/icon/CopyLink.png";
import Bin from "./../img/icon/icBin.png";
import Comment from "./../img/icon/icChat.png";
import AnonymousAnswer from "./AnonymousAnswer";
import Delete from "./popup/Delete";
import { getReceivedComment } from "../api/getReceivedComment";
import { getSpaceInfo } from "../api/getSpaceInfo";
import UntilAnswering from "./UntilAnswering";
import { DateTimeFormatter, LocalDateTime, ChronoUnit } from "js-joda";
import { ZoneId, ZoneRulesProvider } from "js-joda-timezone";
import AnswerRegister from "./popup/AnswerRegister";
import CantModal from "./popup/CantRegister";

function ReceiveComment({ spaceId, currentUserInfo }) {
  const [receivedComments, setReceivedComments] = useState([]);
  // ÏßàÎ¨∏ ÏÇ≠Ï†ú ÏÉÅÌÉúÍ∞í
  const [deleteStates, setDeleteStates] = useState({});

  // ÏßàÎ¨∏Îç∞Ïù¥ÌÑ∞ Î∞∞Ïó¥ ÏÉÅÌÉúÍ∞í
  const [questionData, setQuestionData] = useState([]);

  // Ïù¥ÎèôÌïú Ïä§ÌéòÏù¥Ïä§ ÏÉÅÌÉúÍ∞í
  const [spaceOwner, setSpaceOwner] = useState({
    userId: "",
    picture: "",
    name: "",
  });

  useEffect(() => {
    const fetchReceivedComments = async () => {
      try {
        const spaInfo = await getSpaceInfo(spaceId);
        const received = await getReceivedComment(spaceId);

        console.log("received:", received);

        const receivedArray = Object.values(received.data).map(
          (item) => item || {}
        );
        console.log("receivedArray:", receivedArray);
        setReceivedComments(receivedArray);
        setSpaceOwner(spaInfo);

        // deleteStates Î∞∞Ïó¥ÏùÑ Î™®Îì† ÏßàÎ¨∏Ïóê ÎåÄÌï¥ Ï¥àÍ∏∞Ìôî
        const initialDeleteStates = receivedArray.map(() => false);
        setDeleteStates(initialDeleteStates);
        moment.locale("ko");
      } catch (error) {
        console.error("Error fetching received comments:", error);
      }
    };

    fetchReceivedComments();
  }, [spaceId]);

  //ÌïòÌä∏ ÏÉÅÌÉúÍ∞í
  const [heartState, setHeartState] = useState(false);
  //Ï¢ãÏïÑÏöî ÏÉÅÌÉúÍ∞í
  const [goodState, setGoodState] = useState(false);
  // Îπà ÌïòÌä∏
  const [heart, setHeart] = useState(LineHeart);
  //Îπà Ï¢ãÏïÑÏöî
  const [good, setGood] = useState(Good);
  //ÏÇ≠Ï†ú ÏÉÅÌÉúÍ∞í
  const [del, setDelete] = useState(false);
  const [del_1, setDelete_1] = useState(false);
  //Í≥µÏú†ÌïòÍ∏∞ ÏÉÅÌÉúÍ∞í
  const [share, setShare] = useState(false);
  const [share_1, setShare_1] = useState(false);
  //Í≥µÏú†ÌïòÍ∏∞ Î™®Îã¨ Ïò§Ìîà ÏÉÅÌÉúÍ∞í
  const [shareModal, setShareModal] = useState(false);
  //ÏÇ≠Ï†ú Î™®Îã¨ Ïò§Ìîà ÏÉÅÌÉúÍ∞í
  const [delModal, setDelModal] = useState(false);
  //Îì±Î°ùÎ∂àÍ∞Ä Î™®Îã¨ Ïò§Ìîà ÏÉÅÌÉúÍ∞í
  const [cantModal, setCantModal] = useState(false);
  const [answerModal, setAnswerModal] = useState(false);

  // ÏÑ†ÌÉùÌïú ÏßàÎ¨∏Ïùò Í≥†Ïú† IDÎ•º ÏÉÅÌÉúÍ∞íÏóê Ï†ÄÏû•
  const [selectedQuestionId, setSelectedQuestionId] = useState([]);
  const [selectedQuestionUserId, setSelectedQuestionUserId] = useState([]);
  const [selectedQuestionUserPic, setSelectedQuestionPic] = useState([]);
  const [selectedQuestionText, setSelectedQuestionText] = useState([]);

  // ÏÑ†ÌÉùÌïú ÏßàÎ¨∏Ïùò Ïù∏Îç±Ïä§
  const [selectedQuestionIndex, setSelectedQuestionIndex] = useState(null);

  //ÌïòÌä∏ ÏÉÅÌÉúÍ∞íÏóê Îî∞Î•∏ Ïù¥ÎØ∏ÏßÄ Î≥ÄÍ≤Ω Ìï®Ïàò
  const clickHeart = () => {
    if (heartState) {
      setHeartState(false);
      setHeart(LineHeart);
    } else {
      setHeartState(true);
      setHeart(Heart);
    }
  };

  //Ï¢ãÏïÑÏöî ÏÉÅÌÉúÍ∞íÏóê Îî∞Î•∏ Ïù¥ÎØ∏ÏßÄ Î≥ÄÍ≤Ω Ìï®Ïàò
  const clickGood = () => {
    if (goodState) {
      setGoodState(false);
      setGood(Good);
    } else {
      setGoodState(true);
      setGood(GoodRed);
    }
  };

  // ÌÅ¥Î¶≠Ìïú ÏßàÎ¨∏Ïóê ÎåÄÌïú ÏÇ≠Ï†ú ÏÉÅÌÉúÍ∞í Î≥ÄÍ≤Ω
  const clickMore = (index) => {
    setDeleteStates((prevStates) => {
      const newStates = [...prevStates];
      newStates[index] = !newStates[index];
      return newStates;
    });
  };

  const clickMore_1 = () => {
    if (del_1) {
      setDelete_1(false);
    } else {
      setDelete_1(true);
    }
  };

  // ÏÇ≠Ï†úÌïòÍ∏∞ ÌÅ¥Î¶≠ Ïãú Î™®Îã¨ Ïò§Ìîà
  const showDelModal = (index) => {
    setSelectedQuestionIndex(index); // ÏÑ†ÌÉùÌïú ÏßàÎ¨∏Ïùò Ïù∏Îç±Ïä§Î•º ÏÉÅÌÉúÍ∞íÏóê Ï†ÄÏû•
    setDelModal(true);
  };

  // ÎëêÎ≤àÏß∏ ÎãµÎ≥Ä Îì±Î°ù Ïãú Î™®Îã¨ Ïò§Ìîà
  const showCantModal = () => {
    setCantModal(true);
  };

  // ÏÇ≠Ï†ú ÌåùÏóÖ  Îã´Í∏∞
  const onClose = (e) => {
    setDelModal(false);
    setCantModal(false);
    setDelete(false);
  };

  //Í≥µÏú†ÌïòÍ∏∞  Ïò§Ìîà
  const showShareModal = () => {
    if (share) {
      setShareModal(false);
      setShare(false);
    } else {
      setShareModal(true);
      setShare(true);
    }
  };

  //Í≥µÏú†ÌïòÍ∏∞  Ïò§Ìîà
  const showShareModal_1 = () => {
    if (share_1) {
      setShareModal(false);
      setShare_1(false);
    } else {
      setShareModal(true);
      setShare_1(true);
    }
  };
  const showAnswerModal = (
    questionId,
    sentUserId,
    sentUserPic,
    questionText
  ) => {
    setAnswerModal(true);
    setSelectedQuestionId(questionId); // ÏÑ†ÌÉùÌïú ÏßàÎ¨∏Ïùò IDÎ•º ÏÉÅÌÉúÍ∞íÏóê Ï†ÄÏû•
    setSelectedQuestionUserId(sentUserId); // ÏÑ†ÌÉùÌïú ÏßàÎ¨∏Ïùò Ïú†Ï†Ä ÏïÑÏù¥ÎîîÎ•º ÏÉÅÌÉúÍ∞íÏóê Ï†ÄÏû•
    setSelectedQuestionPic(sentUserPic); // ÏÑ†ÌÉùÌïú ÏßàÎ¨∏Ïùò Ïú†Ï†Ä ÏÇ¨ÏßÑÍ∞íÏùÑ ÏÉÅÌÉúÍ∞íÏóê Ï†ÄÏû•
    setSelectedQuestionText(questionText); // ÏÑ†ÌÉùÌïú ÏßàÎ¨∏Ïùò ÎÇ¥Ïö© ÏÉÅÌÉúÍ∞íÏóê Ï†ÄÏû•
  };

  const closeAnswerModal = () => {
    setAnswerModal(false);
  };

  const onClickcopy = () => {
    setShare(false);
    alert("ÎßÅÌÅ¨Í∞Ä Î≥µÏÇ¨ ÎêòÏóàÏäµÎãàÎã§");
  };

  return (
    <>
      {receivedComments.length === 0 && <p>Ï≤´ ÏßàÎ¨∏ÏùÑ ÎÇ®Í≤® Î≥¥ÏÑ∏Ïöîüëª</p>}
      {receivedComments
        .slice()
        .reverse()
        .map((received, index) => (
          <React.Fragment key={index}>
            <div key={index} className="commentWrap questionWrap">
              <div className="profileArea">
                <img
                  src={received.sentUserPic}
                  alt="profile1"
                  className="questioner"
                />
              </div>
              <div className="cnt">
                <p className="Nicname">{received.userId}</p>
                <p className="min">{getTimeDifference(received.createdTime)}</p>
                <p className="commentCnt">{received.questionText}</p>
                <div className="heart">
                  <img src={heart} alt="ÌïòÌä∏" onClick={clickHeart} />

                  
                  {received.answers.length > 0 ? (
                    <>
                      <img
                        src={Comment}
                        alt="comment"
                        className="chat"
                        onClick={showCantModal}
                      />
                    </>
                  ) : (
                    <>
                    {currentUserInfo.userId !== spaceOwner.userId? (
                      ""
                    ): (
                      <img
                      src={Comment}
                      alt="comment"
                      className="chat"
                      onClick={() =>
                        showAnswerModal(
                          received.id,
                          received.userId,
                          received.sentUserPic,
                          received.questionText
                        )
                      }
                    />
                    )}

                    </>
                  )}
                </div>
                <div className="more">
                  <img src={More} alt="more" onClick={() => clickMore(index)} />
                  {deleteStates[index] && (
                    <div className="del" onClick={() => showDelModal(index)}>
                      <p>
                        <img src={Bin} alt="btin" />
                        ÏÇ≠Ï†úÌïòÍ∏∞
                      </p>
                    </div>
                  )}
                </div>
                <div className="share">
                  <img src={Share} alt="share" onClick={showShareModal} />
                  {share && (
                    <div className="sharePopup">
                      <p>
                        <img src={InstaLogo} alt="insta" />
                        Ïä§ÌÜ†Î¶¨
                      </p>
                      <p onClick={onClickcopy}>
                        <img src={CopyLink} alt="link" />
                        ÎßÅÌÅ¨ Î≥µÏÇ¨
                      </p>
                    </div>
                  )}
                </div>
              </div>
            </div>

            <div className="commentWrap answerWrap">
              <div className="profileArea">
                <img
                  src={spaceOwner.picture}
                  alt="profile2"
                  className="respondent"
                />
              </div>
              <div className="cnt">
                <p className="Nicname">{spaceOwner.name}</p>

                {received.answers.length === 0 ? (
                  <UntilAnswering></UntilAnswering>
                ) : (
                  <>
                    <p className="min">
                      {getTimeDifference(received.answers[0].createdTime)}
                    </p>
                    <AnonymousAnswer question={received} answers={received.answers} currentUserInfo={currentUserInfo} />
                  </>
                )}

                <div className="heart">
                  <img src={good} alt="good" onClick={clickGood} />
                </div>
                <div className="more">
                  <img src={More} alt="more" onClick={clickMore_1} />
                  {del_1 && (
                    <div className="del" onClick={showDelModal}>
                      <p>
                        <img src={Bin} alt="btin" />
                        ÏÇ≠Ï†úÌïòÍ∏∞
                      </p>
                    </div>
                  )}
                </div>
                <div className="share">
                  <img src={Share} alt="share" onClick={showShareModal_1} />
                  {share_1 && (
                    <div className="sharePopup">
                      <p>
                        <img src={InstaLogo} alt="insta" />
                        Ïä§ÌÜ†Î¶¨
                      </p>
                      <p onClick={onClickcopy}>
                        <img src={CopyLink} alt="link" />
                        ÎßÅÌÅ¨ Î≥µÏÇ¨
                      </p>
                    </div>
                  )}
                </div>
              </div>
              {/* ÏÇ≠Ï†úÌïòÍ∏∞ ÌåùÏóÖ  */}
              {delModal && <Delete onClose={onClose}></Delete>}
              {/* -- Îì±Î°ùÎ∂àÍ∞Ä ÌåùÏóÖ */}
              {cantModal && <CantModal onClose={onClose}></CantModal>}
            </div>
          </React.Fragment>
        ))}
      {answerModal && (
        <AnswerRegister
          CloseAnswerModal={closeAnswerModal}
          currentUserInfo={currentUserInfo}
          questionId={selectedQuestionId}
          sentUserId={selectedQuestionUserId}
          sentUserPic={selectedQuestionUserPic}
          questionText={selectedQuestionText}
        ></AnswerRegister>
      )}
    </>
  );
}

export default ReceiveComment;

// ÏßàÎ¨∏ Îì±Î°ù ÏãúÍ∞ÑÍ≥º ÌòÑÏû¨ ÏãúÍ∞Ñ ÏÇ¨Ïù¥Ïùò Ï∞®Ïù¥Î•º Í≥ÑÏÇ∞ÌïòÎäî Ìï®Ïàò
function getTimeDifference(createdTime) {
  return moment(createdTime).locale("ko").fromNow();
}
